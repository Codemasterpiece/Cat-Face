<!DOCTYPE html>
<!-- Developed by CMG
VERSION : 1.0
UPDATED : 230219 -->

<html>
	<head>
		<link rel="stylesheet" href="style.css" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	</head>
	<body>
		<body onload="init();">
			<div class="title">고양이 감별사</div>
			<div class="subtitle">내 고양이는 어떤 고양이일까?</div>
			<button class="start-button" type="button" onclick="init(); predict();">
				감별 시작
			</button>
			<script
				class="jsbin"
				src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"
			></script>
			<div class="file-upload">
				<button
					class="file-upload-btn"
					type="button"
					onclick="$('.file-upload-input').trigger( 'click' )"
				>
					업로드
				</button>

				<div class="image-upload-wrap">
					<input
						class="file-upload-input"
						type="file"
						onchange="readURL(this);"
						accept="image/*"
					/>
					<div class="drag-text">
						<h3>사진을 업로드 해주시고 위의 '감별 시작'을 더블 클릭 해주세요.</h3>
					</div>
				</div>
				<div class="file-upload-content">
					<img class="file-upload-image" id="catimage" src="#" alt="your image" />
					<div class="image-title-wrap"></div>
				</div>
			</div>
			<div class="chart-container">
			  <div class="chart-bar">
				<div class="bar-label">1순위 예측</div>
				<div class="bar-percent" id="prob1"></div>
			  </div>
			  <div class="chart-bar">
				<div class="bar-label">2순위 예측</div>
				<div class="bar-percent" id="prob2"></div>
			  </div>
			  <div class="chart-bar">
				<div class="bar-label">3순위 예측</div>
				<div class="bar-percent" id="prob3"></div>
			  </div>
			</div>
			<div id="result-container" class=""></div>
			<div id="webcam-container"></div>
			<div id="label-container"></div>
			<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
			<script>
				function readURL(input) {
					if (input.files && input.files[0]) {
						var reader = new FileReader();

						reader.onload = function (e) {
							$('.image-upload-wrap').hide();

							$('.file-upload-image').attr('src', e.target.result);
							$('.file-upload-content').show();

							$('.image-title').html(input.files[0].name);
						};

						reader.readAsDataURL(input.files[0]);
					} else {
						removeUpload();
					}
				}

				function removeUpload() {
					$('.file-upload-input').replaceWith($('.file-upload-input').clone());
					$('.file-upload-content').hide();
					$('.image-upload-wrap').show();
				}
				$('.image-upload-wrap').bind('dragover', function () {
					$('.image-upload-wrap').addClass('image-dropping');
				});
				$('.image-upload-wrap').bind('dragleave', function () {
					$('.image-upload-wrap').removeClass('image-dropping');
				});
			</script>
			<script type="text/javascript">
				// More API functions here:
				// https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/image

				// the link to your model provided by Teachable Machine export panel
				const URL = 'https://teachablemachine.withgoogle.com/models/IiP6kEV82/';

				let model, webcam, labelContainer, maxPredictions;

				// Load the image model and setup the webcam
				async function init() {
					const modelURL = URL + 'model.json';
					const metadataURL = URL + 'metadata.json';

					// load the model and metadata
					// Refer to tmImage.loadFromFiles() in the API to support files from a file picker
					// or files from your local hard drive
					// Note: the pose library adds "tmImage" object to your window (window.tmImage)
					model = await tmImage.load(modelURL, metadataURL);
					maxPredictions = model.getTotalClasses();
					labelContainer = document.getElementById('label-container');
					for (let i = 0; i < maxPredictions; i++) {
						// and class labels
						labelContainer.appendChild(document.createElement('div'));
					}
				}
				async function predict() {
					var image = document.getElementById('catimage');
					const prediction = await model.predict(image, false);
					let maxIndex = 0;
					let maxProb = 0;
					let secondMaxIndex = 0;
					let secondMaxProb = 0;
					let thirdMaxIndex = 0;
					let thirdMaxProb = 0;

					for (let i = 0; i < maxPredictions; i++) {
						if (prediction[i].probability > maxProb) {
							thirdMaxIndex = secondMaxIndex;
							thirdMaxProb = secondMaxProb;
							secondMaxIndex = maxIndex;
							secondMaxProb = maxProb;
							maxIndex = i;
							maxProb = prediction[i].probability;
						} else if (prediction[i].probability > secondMaxProb) {
							thirdMaxIndex = secondMaxIndex;
							thirdMaxProb = secondMaxProb;
							secondMaxIndex = i;
							secondMaxProb = prediction[i].probability;
						} else if (prediction[i].probability > thirdMaxProb) {
							thirdMaxIndex = i;
							thirdMaxProb = prediction[i].probability;
						}
					}

					const probabilityPercent = Math.round(maxProb * 100);
					const secondProbabilityPercent = Math.round(secondMaxProb * 100);
					const thirdProbabilityPercent = Math.round(thirdMaxProb * 100);
					const classNames = ['코리안 쇼트헤어','노르웨이 숲 고양이 (Norwegian Forest Cat)','데본렉스 (Devon Rex)','라가머핀 (Ragamuffin)','라팜 (LaPerm)','랙돌 (Ragdoll)','러시안 블루 (Russian Blue)','맹크스 (Manx)','먼치킨 (Munchkin)','메인쿤 (Maine Coon)','발리네즈 (Balinese)','버만 (Birman)','버미즈 (Burmese)','봄베이 고양이(Bombay)','브리티쉬 쇼트헤어 (British Shorthair)','시베리아 고양이 (Siberian)','샴고양이 (Siamese)','샤트룩스 (Chartreux)','셀커크 렉스 (Selkirk Rex)','소말리 고양이(Somali)','스코티시 폴드 (Scottish Fold)','스핑크스 (Sphynx)','싱가퓨라 (Singapura)','아메리칸 밥테일 (American Bobtail','아메리칸 쇼트헤어 (American Shorthair)','아메리칸 와이어헤어 (American Wirehair)','아메리칸 컬 (American Curl)','아비시니안 고양이 (Abyssinian)','오리엔탈 고양이 (Oriental)','오시캣 (Ocicat)','유러피안 버미즈 (European Burmese)','이그저틱 (Exotic)','이집션 마우 (Egyptian Mau)','자바니즈 (Javanese)','재패니즈 밥테일 (Japanese Bobtail)','컬러포인트 쇼트헤어 (Colorpoint Shorthair)','코랫 (Korat)','터키시 반 (Turkish Van)','터키시 앙고라 (Turkish Angora)','통키니즈 (Tonkinese)','페르시안 고양이 (Persian)','하바나 브라운 (Havana Brown)','터볼드 (Peterbald)','네벨룽 (Nebelung)','토이거 (Toyger)','픽시 밥 (Pixie-bob)','스노우슈 (Snowshoe)','사바나 (Savannah)','사트트뢰 (Siberian)','오리엔탈 쇼트헤어 (Oriental Shorthair)','히말리안 고양이 (Himalayan)','엑조틱 숏헤어 (Exotic Shorthair)','벵골고양이 (Bengal)'];
					const maxClassName = classNames[maxIndex];
					const query = maxClassName.split(' ').join('_');
					const wikiSearchUrl = `https://ko.wikipedia.org/w/index.php?search=${query}&title=특수:검색&go=문서&ns0=1`;
				    const resultHTML =
    				`<a href="${wikiSearchUrl}" target="_blank">위키피디아에서 1순위 예측 고양이 더 알아보기</a>`;
					
					document.getElementById('result-container').innerHTML = resultHTML;
					
					document.getElementById("prob1").innerHTML = `${maxClassName}<br> ${probabilityPercent}%`;
					document.getElementById("prob2").innerHTML = `${classNames[secondMaxIndex]}<br> ${secondProbabilityPercent}%`;
					document.getElementById("prob3").innerHTML = `${classNames[thirdMaxIndex]}<br> ${thirdProbabilityPercent}%`;

				}
			</script>
		</body>
	</body>
</html>